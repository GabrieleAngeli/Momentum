name: PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  ci:
    name: CI and FE Lint Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.14.0-pg16
        env:
          POSTGRES_PASSWORD: postgres
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: NPM install web-core
        run: npm ci --prefix src/web-core

      - name: Lint web-core
        run: npm run lint --prefix src/web-core

      - name: Test web-core with coverage
        run: npm test --prefix src/web-core -- --watch=false --code-coverage

      - name: Upload coverage artifact (FE)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-core-coverage
          path: src/web-core/coverage

      - uses: codecov/codecov-action@v4
        if: always()
        with:
          files: src/web-core/coverage/cobertura-coverage.xml,src/web-core/coverage/lcov.info
          flags: frontend

      - name: Validate JSON ScheMAS (AJV)
        if: always()
        run: |
          npm i -g ajv-cli
          chmod +x ./tests/Contracts/schema-validation.test.sh
          ./tests/Contracts/schema-validation.test.sh

      - name: Upload contracts artifact
        uses: actions/upload-artifact@v4
        with:
          name: contracts
          path: contracts
          if-no-files-found: ignore

  test_dotnet:
    name: DotNet Tests and Audit
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Test (.NET) with coverage (Coverlet)
        run: |
          mkdir -p ./test-results
          mkdir -p ./test-results/coverage
          dotnet test Momentum.sln -c Release \
            --logger "trx" \
            --results-directory ./test-results \
            --collect:"XPlat Code Coverage"

      - name: List results
        if: always()
        run: ls -R ./test-results || true

      - name: Publish .NET test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit & Integration (.NET)
          path: ./test-results/**/*.trx
          reporter: dotnet-trx

      - name: Generate coverage report (ReportGenerator)
        run: |
          dotnet tool update -g dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"./test-results/**/coverage.cobertura.xml" \
            -targetdir:"./test-results/coveragereport" \
            -reporttypes:"Html;TextSummary"
          cat ./test-results/coveragereport/Summary.txt || true

      - name: Upload coverage artifact (.NET)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-coverage
          path: ./test-results/coveragereport

      - uses: codecov/codecov-action@v4
        with:
          files: ./test-results/coverage/**/coverage.cobertura.xml
          flags: backend

  issue_linking:
    name: Issue Linking Auto Create
    runs-on: ubuntu-latest
    needs: [test_dotnet]
    if: >
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft &&
      needs.test_dotnet.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          if [ -f tools/issue_management/requirements.txt ]; then
            pip install -r tools/issue_management/requirements.txt
          fi

      - name: Ensure commits reference issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/issue_management/ensure_issue_links.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --auto-create

  pr_doc_autopilot:
    name: PR Doc Autopilot Commit Push
    runs-on: ubuntu-latest
    needs: [issue_linking]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run PR Codex Autopilot
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL: gpt-4o-mini
          MAX_DIFF_CHARS: "60000"
          MAX_CONTEXT_CHARS: "8000"
          MAX_BODY_CHARS: "3000"
        run: |
          python -m pip install -U pip
          pip install -r tools/ci/requirements.txt
          python tools/ci/pr_codex_autopilot.py \
            --pr "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}"

      - name: Commit changes if any
        id: commit_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          else
            git add -A
            git commit -m "docs: auto-update (codex) [skip ci]"
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.commit_changes.outputs.did_commit == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "HEAD:${{ github.head_ref }}"

  release_notes_preview:
    name: Release Notes Preview (LLM enriched, sticky)
    runs-on: ubuntu-latest
    needs: [test_dotnet, issue_linking, pr_doc_autopilot]
    permissions:
      contents: read
      pull-requests: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LLM_MODEL: gpt-4o-mini
      LLM_TEMPERATURE: "0.2"
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install release-notes deps
        run: |
          python -m pip install -U pip
          if [ -f tools/release_notes/requirements.txt ]; then
            pip install -r tools/release_notes/requirements.txt
          fi
          python - <<'PY'
          import sys, subprocess
          subprocess.check_call([sys.executable, "-m", "pip", "install", "requests"])
          PY

      # --- Aggiungi .NET per gitversion (global tool) ---
      - name: Setup .NET (for GitVersion)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # --- Installa GitVersion (aggiunge dotnet-gitversion al PATH) ---
      - name: Install GitVersion
        uses: GitTools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: '5.x'        # oppure una versione specifica tipo '5.12.0'

      - name: GitVersion
        id: gv
        uses: GitTools/actions/gitversion/execute@v0.10.2
        with:
          useConfigFile: false

      - name: Set preview tag from GitVersion
        id: preview_tag
        run: echo "preview_tag=${{ steps.gv.outputs.semVer }}" >> "$GITHUB_OUTPUT"

      - name: Compute PR diff range
        id: pr_range
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "base=${BASE_SHA}" >> "$GITHUB_OUTPUT"
          echo "head=${HEAD_SHA}" >> "$GITHUB_OUTPUT"

      - name: Generate LLM-enriched preview notes (Markdown)
        id: gen
        env:
          ENABLE_LLM: "true"
          LLM_PROVIDER: "openai"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ReleaseNotes
          OUT="ReleaseNotes/${{ steps.preview_tag.outputs.preview_tag }}.md"
          python tools/release_notes/generate_release_notes.py \
            --base "${{ steps.pr_range.outputs.base }}" \
            --head "${{ steps.pr_range.outputs.head }}" \
            --version "${{ steps.preview_tag.outputs.preview_tag }}" \
            --out "${OUT}"
          echo "file=${OUT}" >> "$GITHUB_OUTPUT"

      - name: Commit preview file on PR branch
        id: push_preview
        continue-on-error: true
        env:
          FILE: ${{ steps.gen.outputs.file }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IS_FORK: ${{ github.event.pull_request.head.repo.fork }}
        run: |
          set -euo pipefail

          # Se Ã¨ un fork: non provare a pushare
          if [ "${IS_FORK}" = "true" ]; then
            echo "PR da fork: push disabilitato."
            echo "pushed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Autenticazione remota con GITHUB_TOKEN
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"

          # Vai sul branch della PR
          git switch "${BRANCH}"

          # Aggiungi il file e committa se serve
          git add "${FILE}"
          if ! git diff --cached --quiet; then
            if git commit -m "docs(release): add LLM preview notes for ${{ steps.preview_tag.outputs.preview_tag }}" && \
              git push origin "HEAD:${BRANCH}"; then
              echo "pushed=true" >> "$GITHUB_OUTPUT"
            else
              echo "WARN: push fallito (permessi/branch protetta). Uso solo il commento sticky." >&2
              echo "pushed=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          else
            echo "Nessuna modifica da committare."
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          fi


      - name: Comment preview on PR (fallback)
        if: ${{ github.event.pull_request.head.repo.fork || steps.push_preview.outputs.pushed != 'true' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: ${{ steps.gen.outputs.file }}

      - name: Comment preview on PR (sticky)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const fs = require('fs');

            const header = '### Release Notes Preview for';
            const tag = `${{ toJSON(steps.preview_tag.outputs.preview_tag) }}`;
            const path = `${{ toJSON(steps.gen.outputs.file) }}`;

            let notes = '';
            try { notes = fs.readFileSync(path, 'utf-8'); } catch {}

            const payload = `${header} **${tag}**\n\n${notes || '_No changes detected for this PR range._'}`;

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 100 });
            const existing = comments.data.find(c =>
              c.user?.type === 'Bot' && typeof c.body === 'string' && c.body.includes(header)
            );

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body: payload });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: payload });
            }
