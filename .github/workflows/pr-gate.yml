name: PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  ci:
    name: CI and FE Lint Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.14.0-pg16
        env:
          POSTGRES_PASSWORD: postgres
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: NPM install web-core
        run: npm ci --prefix src/web-core

      - name: Lint web-core
        run: npm run lint --prefix src/web-core

      - name: Test web-core with coverage
        run: npm test --prefix src/web-core -- --watch=false --code-coverage

      - name: Upload coverage artifact (FE)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-core-coverage
          path: src/web-core/coverage

      # (Opzionale) Pubblica in Codecov
      - uses: codecov/codecov-action@v4
        if: always()
        with:
          files: src/web-core/coverage/cobertura-coverage.xml,src/web-core/coverage/lcov.info
          flags: frontend

      # FACOLTATIVO: valida gli schemi JSON (toglie il || true dallo script)
      - name: Validate JSON Schemas (AJV)
        if: always()
        run: |
          npm i -g ajv-cli
          chmod +x ./tests/Contracts/schema-validation.test.sh
          ./tests/Contracts/schema-validation.test.sh

      - name: Upload contracts artifact
        uses: actions/upload-artifact@v4
        with:
          name: contracts
          path: contracts
          if-no-files-found: ignore

  test_dotnet:
    name: DotNet Tests and Audit
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Test (.NET) with coverage (Coverlet)
        run: |
          mkdir -p ./test-results
          mkdir -p ./test-results/coverage
          dotnet test Momentum.sln -c Release \
            --logger "trx" \
            --results-directory ./test-results \
            --collect:"XPlat Code Coverage"

      - name: List results
        if: always()
        run: ls -R ./test-results || true

      - name: Publish .NET test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit & Integration (.NET)
          path: ./test-results/**/*.trx
          reporter: dotnet-trx

      # HTML summary / badge opzionali
      - name: Generate coverage report (ReportGenerator)
        run: |
          dotnet tool update -g dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"./test-results/**/coverage.cobertura.xml" \
            -targetdir:"./test-results/coveragereport" \
            -reporttypes:"Html;TextSummary"
          cat ./test-results/coveragereport/Summary.txt || true

      - name: Upload coverage artifact (.NET)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-coverage
          path: ./test-results/coveragereport

      - uses: codecov/codecov-action@v4
        with:
          files: ./test-results/coverage/**/coverage.cobertura.xml
          flags: backend
  
  issue_linking:
    name: Issue Linking Auto Create
    runs-on: ubuntu-latest
    needs: [ci]
    if: >
      github.event_name == 'pull_request' &&
      contains(fromJson('["opened","reopened","ready_for_review","labeled"]'), github.event.action) &&
      !github.event.pull_request.draft
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          if [ -f tools/issue_management/requirements.txt ]; then
            pip install -r tools/issue_management/requirements.txt
          fi

      - name: Ensure commits reference issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/issue_management/ensure_issue_links.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --auto-create
  
  release_notes_pr:
    name: Release Notes Preview (commit on PR branch)
    runs-on: ubuntu-latest
    needs:
      - ci
      - test_dotnet
    permissions:
      contents: write
      pull-requests: write
    if: ${{ success() }}  # esegue solo se i job necessari sono passati
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next SemVer from PR commits
        id: semver
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          # prendi l’ultimo tag (se non c’è, parti da v0.1.0)
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || echo v0.1.0)"
          BASE_VERSION="${LAST_TAG#v}"

          # analizza SOLO i commit del PR
          COMMITS="$(git log --pretty=format:%s "${BASE_SHA}..${HEAD_SHA}" || true)"

          BUMP="patch"
          if echo "${COMMITS}" | grep -Eqi 'BREAKING CHANGE|!:' ; then
            BUMP="major"
          elif echo "${COMMITS}" | grep -Eqi '^feat(\(|:)|^feat!'; then
            BUMP="minor"
          elif echo "${COMMITS}" | grep -Eqi '^fix(\(|:)|^fix!'; then
            BUMP="patch"
          else
            if [[ -n "${COMMITS}" ]]; then BUMP="patch"; fi
          fi

          IFS='.' read -r MA MI PA <<< "${BASE_VERSION}"
          case "${BUMP}" in
            major) MA=$((MA+1)); MI=0; PA=0;;
            minor) MI=$((MI+1)); PA=0;;
            patch) PA=$((PA+1));;
          esac

          NEXT="${MA}.${MI}.${PA}"
          TAG="v${NEXT}-rc.PR-${{ github.event.pull_request.number }}"

          echo "next=${NEXT}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"   >> "$GITHUB_OUTPUT"

      - name: Generate Release Notes (GitHub API)
        id: ghnotes
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = "${{ steps.semver.outputs.tag }}";
            // genera le note puntando alla HEAD del PR
            const target = context.payload.pull_request.head.sha;
            const res = await github.rest.repos.generateReleaseNotes({
              owner, repo, tag_name: tag, target_commitish: target
            });
            core.setOutput('body', res.data.body || '');

      # commit SOLO se non è un fork (secrets non disponibili su fork)
      - name: Commit preview notes on PR branch
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        run: |
          set -euo pipefail
          BRANCH="${{ github.head_ref }}"
          mkdir -p ReleaseNotes
          FILE="ReleaseNotes/${{ steps.semver.outputs.tag }}.md"
          printf "%s" "${{ steps.ghnotes.outputs.body }}" > "${FILE}"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git switch "${BRANCH}"
          git add "${FILE}"
          if ! git diff --cached --quiet; then
            git commit -m "docs(release): add preview notes for ${{ steps.semver.outputs.tag }}"
            git push origin "${BRANCH}"
          fi

      # in ogni caso, commento sul PR per la preview
      - name: Comment preview on PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### Release Notes Preview for **${{ steps.semver.outputs.tag }}**
            
            ${ { toString: () => '${{ steps.ghnotes.outputs.body }}' } }
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

  pr_doc_autopilot:
    name: PR Doc Autopilot Commit Push
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run PR Codex Autopilot
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        continue-on-error: true   # <— non bloccare il job in caso di skip/limiti
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL: gpt-4o-mini
          MAX_DIFF_CHARS: "60000"
          MAX_CONTEXT_CHARS: "8000"
          MAX_BODY_CHARS: "3000"
        run: |
          python -m pip install -U pip
          pip install -r tools/ci/requirements.txt
          python tools/ci/pr_codex_autopilot.py \
            --pr "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}"

      - name: Commit changes if any
        id: commit_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          else
            git add -A
            git commit -m "docs: auto-update (codex) [skip ci]"
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.commit_changes.outputs.did_commit == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "HEAD:${{ github.head_ref }}"

  release_notes_preview:
    name: Release Notes Preview Comment
    runs-on: ubuntu-latest
    needs: [ci, test_dotnet]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate preview from PR commits
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const base = context.payload.pull_request.base.sha;
            const head = context.payload.pull_request.head.sha;
            const res = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base,
              head
            });
            const groups = {
              feat:[], fix:[], perf:[], refactor:[], docs:[],
              chore:[], ci:[], test:[], style:[], revert:[]
            };
            for (const c of res.data.commits) {
              const msg = c.commit.message.split('\n')[0];
              const m = msg.match(/^(\w+)(\([\w\-\./]+\))?:(.*)$/);
              const type = (m && m[1]) ? m[1] : 'chore';
              const bucket = groups[type] || groups['chore'];
              bucket.push('- ' + msg + ' (' + c.sha.substring(0,7) + ')');
            }
            function section(t, l) { return l.length ? ('### ' + t + '\n' + l.join('\n') + '\n') : ''; }
            const body =
              section('Features', groups.feat) +
              section('Fixes', groups.fix) +
              section('Performance', groups.perf) +
              section('Refactor', groups.refactor) +
              section('Docs', groups.docs) +
              section('CI', groups.ci) +
              section('Tests', groups.test) +
              section('Chore', groups.chore) +
              section('Style', groups.style) +
              section('Revert', groups.revert);
            core.setOutput('body', body || 'No categorized changes.');

      - name: Comment Preview on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const body = `${{ toJson(steps.notes.outputs.body) }}`;
            const cleaned = body.startsWith('"') ? body.slice(1, -1).replace(/\\"/g, '"') : body;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: cleaned
            });
