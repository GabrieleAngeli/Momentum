name: PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  ci:
    name: CI / Build + Frontend Lint/Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.14.0-pg16
        env:
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET (Release)
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: NPM install (web-core)
        run: npm ci --prefix src/web-core

      - name: Lint (web-core)
        run: npm run lint --prefix src/web-core

      - name: Test (web-core)
        run: npm test --prefix src/web-core -- --watch=false

      - name: Upload contracts artifact
        uses: actions/upload-artifact@v4
        with:
          name: contracts
          path: contracts
          if-no-files-found: ignore

  test_dotnet:
    name: .NET Tests + Audit
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Test (.trx)
        run: |
          dotnet test Momentum.sln -c Release --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory ./test-results

      - name: Publish Test Results (Checks)
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests
          path: 'test-results/*.trx'
          reporter: dotnet-trx

      - name: Upload Test Audit
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-audit
          path: test-results
          retention-days: 30

  dep_check:
    name: OWASP Dependency Check (optional)
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - uses: actions/checkout@v4
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@1.1.0
        with:
          project: Momentum
          path: .
          format: HTML
          out: reports
          args: --failOnCVSS 7
      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports

  issue_linking:
    name: Issue Linking (auto-create via script)
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r tools/issue_management/requirements.txt
      - name: Ensure commits reference issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/issue_management/ensure_issue_links.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --auto-create

  pr_doc_autopilot:
    name: PR Doc Autopilot (commit & push)
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run PR Codex Autopilot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m pip install -U pip
          # pip install -r tools/ci/requirements.txt  # se necessario
          python tools/ci/pr_codex_autopilot.py --pr "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}"

      - name: Commit changes (if any)
        id: commit_changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          if git diff --quiet; then
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          else
            git add -A
            git commit -m 'docs: auto-update (codex) [skip ci]'
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.commit_changes.outputs.did_commit == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git push origin HEAD:${{ github.head_ref }}

  release_notes_preview:
    name: Release Notes (Preview comment)
    runs-on: ubuntu-latest
    needs: [ci, test_dotnet]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate preview from PR commits
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const base = context.payload.pull_request.base.sha;
            const head = context.payload.pull_request.head.sha;
            const { data } = await github.rest.repos.compareCommits({
              owner: context.repo.owner, repo: context.repo.repo, base, head
            });
            const groups = { feat:[], fix:[], perf:[], refactor:[], docs:[], chore:[], ci:[], test:[], style:[], revert:[] };
            for (const c of data.commits) {
              const msg = c.commit.message.split('\n')[0];
              const m = msg.match(/^(\w+)(\([\w\-\./]+\))?:(.*)$/);
              const type = (m && m[1]) || 'chore';
              (groups[type] ?? groups['chore']).push('- ' + msg + ' (' + c.sha.substring(0,7) + ')');
            }
            function section(t,l){return l.length?('### ' + t + '\n' + l.join('\n') + '\n'):''}
            const body =
              section('Features', groups.feat)+
              section('Fixes', groups.fix)+
              section('Performance', groups.perf)+
              section('Refactor', groups.refactor)+
              section('Docs', groups.docs)+
              section('CI', groups.ci)+
              section('Tests', groups.test)+
              section('Chore', groups.chore)+
              section('Style', groups.style)+
              section('Revert', groups.revert) || 'No categorized changes.';
            core.setOutput('body', body);

      - name: Comment Preview on PR
        uses: actions/github-script@v7
        env:
          NOTES: ${{ steps.notes.outputs.body }}
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const body = (process.env.NOTES || '');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'üìù **Release Notes (preview)**\n\n' + body
            });
