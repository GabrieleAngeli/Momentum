version: '3.9'
services:
  kafka:
    image: bitnami/kafka:3.6
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
  zookeeper:
    image: bitnami/zookeeper:3.9.1
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"
  timescale:
    image: timescale/timescaledb:2.14.0-pg16
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=momentum
    ports:
      - "5432:5432"
  ignite:
    image: apacheignite/ignite:2.16.0
    ports:
      - "10800:10800"
      - "11211:11211"
  prometheus:
    image: prom/prometheus:v2.49.0
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
  grafana:
    image: grafana/grafana:10.4.0
    ports:
      - "3000:3000"
  loki:
    image: grafana/loki:3.0.0
    ports:
      - "3100:3100"
  tempo:
    image: grafana/tempo:2.4.0
    ports:
      - "3200:3200"
  identifier-api:
    build: ./src/services/identifier/Identifier.Api
    environment:
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "5001:8080"
    depends_on:
      - kafka
  streamer-api:
    build: ./src/services/streamer/Streamer.Api
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__Timescale=Host=timescale;Username=postgres;Password=postgres;Database=momentum
    ports:
      - "5002:8080"
    depends_on:
      - kafka
      - timescale
  notifier-api:
    build: ./src/services/notifier/Notifier.Api
    environment:
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "5003:8080"
    depends_on:
      - kafka
  web-backend-core:
    build: ./src/services/web-backend-core/WebBackendCore.Api
    environment:
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "5004:8080"
    depends_on:
      - notifier-api
  web-core:
    build:
      context: ./src/web-core
      dockerfile: Dockerfile
    ports:
      - "4200:80"
    depends_on:
      - web-backend-core
