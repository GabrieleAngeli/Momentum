name: Post-Merge Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with: { ref: main, fetch-depth: 0 }

      - name: Setup Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Compute next version (Conventional Commits)
        id: semver
        run: |
          LAST_TAG=$(git describe --tags --match "v[0-9]*" --abbrev=0 2>/dev/null || echo "v0.0.0")
          COMMITS=$(git log --pretty=%s ${LAST_TAG}..HEAD || true)
          inc_major=0; inc_minor=0; inc_patch=0
          while IFS= read -r line; do
            echo "$line" | grep -qi "BREAKING CHANGE" && inc_major=1 && continue
            echo "$line" | grep -qiE "^feat(\(|:)" && inc_minor=1 && continue
            echo "$line" | grep -qiE "^fix(\(|:)|^perf(\(|:)|^refactor(\(|:)" && inc_patch=1 && continue
          done <<< "$COMMITS"
          ver="${LAST_TAG#v}"; IFS='.' read -r MA MI PA <<< "$ver"
          if [ $inc_major -eq 1 ]; then MA=$((MA+1)); MI=0; PA=0
          elif [ $inc_minor -eq 1 ]; then MI=$((MI+1)); PA=0
          else PA=$((PA+1)); fi
          echo "next_version=v${MA}.${MI}.${PA}" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          REL="release/${{ steps.semver.outputs.next_version }}"
          git checkout -b "$REL"
          git push origin "$REL"

      - name: Tag main commit
        run: |
          TAG="${{ steps.semver.outputs.next_version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Generate release notes (GitHub)
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = "${{ steps.semver.outputs.next_version }}";
            const res = await github.rest.repos.generateReleaseNotes({
              owner, repo, tag_name: tag, target_commitish: "main"
            });
            core.setOutput('body', res.data.body || ' ')

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.next_version }}
          target_commitish: main
          body: ${{ steps.notes.outputs.body }}
          draft: true
