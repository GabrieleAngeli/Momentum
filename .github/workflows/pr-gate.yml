name: PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

jobs:
  ci:
    name: CI and FE Lint Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.14.0-pg16
        env:
          POSTGRES_PASSWORD: postgres
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: NPM install web-core
        run: npm ci --prefix src/web-core

      - name: Lint web-core
        run: npm run lint --prefix src/web-core

      - name: Test web-core with coverage
        run: npm test --prefix src/web-core -- --watch=false --code-coverage

      - name: Upload coverage artifact (FE)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-core-coverage
          path: src/web-core/coverage

      # (Opzionale) Pubblica in Codecov
      - uses: codecov/codecov-action@v4
        if: always()
        with:
          files: src/web-core/coverage/cobertura-coverage.xml,src/web-core/coverage/lcov.info
          flags: frontend

      # FACOLTATIVO: valida gli schemi JSON (toglie il || true dallo script)
      - name: Validate JSON Schemas (AJV)
        if: always()
        run: |
          npm i -g ajv-cli
          chmod +x ./tests/Contracts/schema-validation.test.sh
          ./tests/Contracts/schema-validation.test.sh

      - name: Upload contracts artifact
        uses: actions/upload-artifact@v4
        with:
          name: contracts
          path: contracts
          if-no-files-found: ignore

  test_dotnet:
    name: DotNet Tests and Audit
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore .NET
        run: dotnet restore Momentum.sln

      - name: Build .NET Release
        run: dotnet build Momentum.sln -c Release --no-restore

      - name: Test (.NET) with coverage (Coverlet)
        run: |
          mkdir -p ./test-results
          dotnet test Momentum.sln -c Release --no-build \
            --logger "trx" \
            --results-directory ./test-results \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./test-results/coverage/

      - name: List results
        if: always()
        run: ls -R ./test-results || true

      - name: Publish .NET test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit & Integration (.NET)
          path: ./test-results/**/*.trx
          reporter: dotnet-trx

      # HTML summary / badge opzionali
      - name: Generate coverage report (ReportGenerator)
        run: |
          dotnet tool update -g dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"./test-results/coverage/**/*.cobertura.xml" \
            -targetdir:"./test-results/coveragereport" \
            -reporttypes:"Html;TextSummary"
          cat ./test-results/coveragereport/Summary.txt || true

      - name: Upload coverage artifact (.NET)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dotnet-coverage
          path: ./test-results/coveragereport

      - uses: codecov/codecov-action@v4
        with:
          files: ./test-results/coverage/**/coverage.cobertura.xml
          flags: backend

  issue_linking:
    name: Issue Linking Auto Create
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          if [ -f tools/issue_management/requirements.txt ]; then
            pip install -r tools/issue_management/requirements.txt
          fi

      - name: Ensure commits reference issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/issue_management/ensure_issue_links.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --auto-create

  pr_doc_autopilot:
    name: PR Doc Autopilot Commit Push
    runs-on: ubuntu-latest
    needs: [ci]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run PR Codex Autopilot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m pip install -U pip
          if [ -f tools/ci/requirements.txt ]; then
            pip install -r tools/ci/requirements.txt
          fi
          python tools/ci/pr_codex_autopilot.py \
            --pr "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}"

      - name: Commit changes if any
        id: commit_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "did_commit=false" >> "$GITHUB_OUTPUT"
          else
            git add -A
            git commit -m "docs: auto-update (codex) [skip ci]"
            echo "did_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changes
        if: steps.commit_changes.outputs.did_commit == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "HEAD:${{ github.head_ref }}"

  release_notes_preview:
    name: Release Notes Preview Comment
    runs-on: ubuntu-latest
    needs: [ci, test_dotnet]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate preview from PR commits
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const base = context.payload.pull_request.base.sha;
            const head = context.payload.pull_request.head.sha;
            const res = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base,
              head
            });
            const groups = {
              feat:[], fix:[], perf:[], refactor:[], docs:[],
              chore:[], ci:[], test:[], style:[], revert:[]
            };
            for (const c of res.data.commits) {
              const msg = c.commit.message.split('\n')[0];
              const m = msg.match(/^(\w+)(\([\w\-\./]+\))?:(.*)$/);
              const type = (m && m[1]) ? m[1] : 'chore';
              const bucket = groups[type] || groups['chore'];
              bucket.push('- ' + msg + ' (' + c.sha.substring(0,7) + ')');
            }
            function section(t, l) { return l.length ? ('### ' + t + '\n' + l.join('\n') + '\n') : ''; }
            const body =
              section('Features', groups.feat) +
              section('Fixes', groups.fix) +
              section('Performance', groups.perf) +
              section('Refactor', groups.refactor) +
              section('Docs', groups.docs) +
              section('CI', groups.ci) +
              section('Tests', groups.test) +
              section('Chore', groups.chore) +
              section('Style', groups.style) +
              section('Revert', groups.revert);
            core.setOutput('body', body || 'No categorized changes.');

      - name: Comment Preview on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const body = `${{ toJson(steps.notes.outputs.body) }}`;
            const cleaned = body.startsWith('"') ? body.slice(1, -1).replace(/\\"/g, '"') : body;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: cleaned
            });
