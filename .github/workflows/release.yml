name: Release automation

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review, labeled, unlabeled ]
  push:
    branches:
      - main
      - 'release/v*'     # FIX: pattern valido per branch tipo release/v1.2.3
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  commitlint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate commit messages
        uses: wagoid/commitlint-github-action@v6

  plan-release:
    if: github.event_name == 'pull_request'
    needs: commitlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/release_notes/requirements.txt -r tools/issue_management/requirements.txt

      - name: Ensure issues are linked to commits
        if: github.event.pull_request.head.repo.fork == false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/issue_management/ensure_issue_links.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --auto-create \
            --labels feature bug tech-debt

      - name: Compute release plan
        id: plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/release_notes/ci_release.py plan \
            --repo "${{ github.repository }}" \
            --head-ref "${{ github.event.pull_request.head.sha }}" \
            --base-ref "${{ github.event.pull_request.base.sha }}" \
            --event-path "$GITHUB_EVENT_PATH" \
            --output-json plan-output.json
          cat plan-output.json
          echo "version=$(jq -r '.version' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "bump=$(jq -r '.bump' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "release_branch=$(jq -r '.release_branch' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "release_notes_path=$(jq -r '.release_notes_path' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "preview_path=$(jq -r '.preview_path' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "pr_body_path=$(jq -r '.pr_body_path' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "should_release=$(jq -r '.should_release' plan-output.json)" >> "$GITHUB_OUTPUT"
          echo "reason=$(jq -r '.reason' plan-output.json)" >> "$GITHUB_OUTPUT"

      - name: Show release notes preview
        run: |
          echo "--- Release Notes Preview ---"
          cat "${{ steps.plan.outputs.preview_path }}" || true
          echo "--------------------------------"

      - name: Update release labels
        if: steps.plan.outputs.should_release == 'true' && github.event.pull_request.head.repo.fork == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for label in release:major release:minor release:patch; do
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "$label" || true
          done
          gh pr edit ${{ github.event.pull_request.number }} --add-label "release:${{ steps.plan.outputs.bump }}"

      - name: Publish release notes preview comment
        if: steps.plan.outputs.should_release == 'true' && github.event.pull_request.head.repo.fork == false
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: ${{ steps.plan.outputs.preview_path }}
          comment-identifier: release-notes-preview

      - name: Create or update release branch PR
        if: steps.plan.outputs.should_release == 'true' && github.event.pull_request.head.repo.fork == false
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: ${{ steps.plan.outputs.release_branch }}
          title: chore: release v${{ steps.plan.outputs.version }}
          body-path: ${{ steps.plan.outputs.pr_body_path }}   # FIX: riga valida; rimosso testo dâ€™errore incollato
          commit-message: chore: prepare release v${{ steps.plan.outputs.version }}
          add-paths: |
            ReleaseNotes/**
          delete-branch: false

  sync-release-branch:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/release_notes/requirements.txt

      - name: Validate release branch artefacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/release_notes/ci_release.py sync \
            --repo "${{ github.repository }}" \
            --head-ref "${{ github.sha }}" \
            --base-ref "${{ github.event.before }}"

  finalize-release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/release_notes/requirements.txt

      - name: Publish tag and GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python tools/release_notes/ci_release.py finalize \
            --repo "${{ github.repository }}" \
            --previous-ref "${{ github.event.before }}"
